<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Adelaide Metro Realtime</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    .leaflet-bottom.leaflet-right {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .filter-box {
  position: absolute;
  bottom: 60px; /* üëà c√°ch ƒë√°y 80px ƒë·ªÉ kh√¥ng ƒë√® l√™n countBox & footerLink */
  left: 10px;
  background: white;
  padding: 8px 12px;
  border-radius: 8px;
  box-shadow: 0 0 10px rgba(0,0,0,0.2);
  z-index: 999;
  font-family: sans-serif;
}

    .count-box {
  position: absolute;
  bottom: 10px;
  left: 10px;
  background: white;
  padding: 6px 12px;
  border-radius: 6px;
  box-shadow: 0 0 5px rgba(0,0,0,0.2);
  font-family: sans-serif;
  font-size: 14px;
  z-index: 999;
}


.footer-link {
  position: absolute;
  bottom: 40px;
  left: 10px;
  font-size: 13px;
  font-family: sans-serif;
  background: rgba(255,255,255,0.9);
  padding: 4px 10px;
  border-radius: 5px;
  box-shadow: 0 0 3px rgba(0,0,0,0.2);
  z-index: 999;
}

.footer-link a {
  color: #0077cc;
  text-decoration: none;
}

.footer-link a:hover {
  text-decoration: underline;
}

.footer-note {
  position: absolute;
  bottom: 10px;
  right: 10px;
  font-size: 12px;
  font-family: sans-serif;
  color: #555;
  opacity: 0.7;
  background: rgba(255, 255, 255, 0.8);
  padding: 4px 10px;
  border-radius: 4px;
  z-index: 999;
}

.footer-note a {
  color: #007acc;
  text-decoration: none;
}

.footer-note a:hover {
  text-decoration: underline;
}

  </style>
</head>
<body>
  
<div id="map"></div>


<div id="countBox" class="count-box"></div>
 


<!-- B·ªô l·ªçc -->
<div class="filter-box">
  <label><input type="checkbox" id="busCheckbox" checked>Display buses</label><br>
  <label><input type="checkbox" id="trainCheckbox" checked>Display trains and trams</label>
</div>

<div class="footer-note">
  üîó <a href="https://www.nguyenlethanh.com" target="_blank">Flinders University | nguyenlethanh.com</a>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  // ===== 1. Base Map Layers =====
  const baseLayers = {
    "Traffic Mode": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap'
    }), 
    "Satellite Mode": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: '¬© Esri'
    })
  };

  const map = L.map('map', {
    center: [-34.9285, 138.6007],
    zoom: 13,
    layers: [baseLayers["Traffic Mode"]]
  });

  L.control.layers(baseLayers, null, { position: 'topright' }).addTo(map);
  map.locate();

  // ===== 2. N√∫t ƒë·ªãnh v·ªã v·ªã tr√≠ ng∆∞·ªùi d√πng =====
  const locateControl = L.control({ position: 'bottomright' });
  locateControl.onAdd = function (map) {
    const div = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
    div.innerHTML = 'üìç';
    div.title = 'Your location';
    div.style.backgroundColor = 'white';
    div.style.width = '34px';
    div.style.height = '34px';
    div.style.lineHeight = '34px';
    div.style.textAlign = 'center';
    div.style.cursor = 'pointer';
    div.onclick = () => {
      map.locate();
    };
    return div;
  };
  locateControl.addTo(map);


  let userLocationMarker = null;


  map.on('locationfound', e => {
  map.setView(e.latlng, 16); // üëà lu√¥n zoom v·ªÅ 13

  if (userLocationMarker) {
    map.removeLayer(userLocationMarker);
  }

  userLocationMarker = L.marker(e.latlng).addTo(map).bindPopup("You are here").openPopup();
});


  // ===== 3. Icon bus & train =====
  const iconBus = new L.Icon({
  iconUrl: 'bus.png',
  iconSize: [40, 40],          // üëà l·ªõn h∆°n m·∫∑c ƒë·ªãnh, nh·ªè h∆°n to nh·∫•t
  iconAnchor: [20, 40],        // üëà ch√≠nh gi·ªØa ƒë√°y icon
  popupAnchor: [0, -40]        // üëà popup hi·ªÉn th·ªã ph√≠a tr√™n icon
});

const iconTrain = new L.Icon({
  iconUrl: 'train.png',
  iconSize: [40, 40],
  iconAnchor: [20, 40],
  popupAnchor: [0, -40]
}); 

function getIconByType(type) {
    return type === 'bus' ? iconBus : type === 'train' ? iconTrain : L.Icon.Default();
  }

  // ===== 4. Hi·ªÉn th·ªã marker t·ª´ API =====
  let markers = [];

  async function fetchAndUpdateMarkers() {
    try {
      const res = await fetch('https://functionappadelaidemetro.azurewebsites.net/api/function3');
      const data = await res.json();

      const showBus = document.getElementById('busCheckbox').checked;
      const showTrain = document.getElementById('trainCheckbox').checked;

      markers.forEach(marker => map.removeLayer(marker));
      markers = [];

      data.forEach(item => {
        const { lat, lng, name, type } = item;

        if ((type === 'bus' && showBus) || (type === 'train' && showTrain)) {
          const marker = L.marker([lat, lng], { icon: getIconByType(type) })
            .addTo(map)
            .bindPopup(`<strong>${name}</strong><br>Type: ${type}`);
          markers.push(marker);
        }
      });


// T√≠nh t·ªïng s·ªë l∆∞·ª£ng theo lo·∫°i
const busCount = data.filter(item => item.type === 'bus' && showBus).length;
const trainCount = data.filter(item => item.type === 'train' && showTrain).length;

// C·∫≠p nh·∫≠t UI
document.getElementById('countBox').innerText = `üöç Buses: ${busCount}    üöÜ Trains/Trams: ${trainCount}`;



    } catch (err) {
      console.error("L·ªói fetch d·ªØ li·ªáu:", err);
    }
  }

  fetchAndUpdateMarkers();
  setInterval(fetchAndUpdateMarkers, 16000);

  // ===== 5. C·∫≠p nh·∫≠t marker khi thay ƒë·ªïi checkbox =====
  document.getElementById('busCheckbox').addEventListener('change', fetchAndUpdateMarkers);
  document.getElementById('trainCheckbox').addEventListener('change', fetchAndUpdateMarkers);
</script>
</body>
</html>
